{% extends "base.html" %}
{% load static %}

{% block title %} payment{% endblock title %}

{% block main %}

    <!-- payment section starts -->

    <section id="payment" class="mt-20 mb-20">
        <div class="container flex flex-col justify-center gap-y-3 md:flex-row md:gap-x-2 rounded-lg py-3 px-5 shadow-lg">
            <div class="form md:w-2/3">
                <h3 class="text-center my-3 text-lg font-medium">Enter Your Delivary Info.</h3>
                <form action="" method="POST" class="bg-white border shadow-md rounded px-8  py-5 mb-4">
                    {% csrf_token %}
                    {% for customarForm in form %}
                    {{customarForm.label_tag}} {{customarForm}} <small class="text-red-600">{{customarForm.errors | linebreaksbr}}</small>
                    {% endfor %}

                    <button class="bg-c_primary py-3 text-center px-6 text-sm md:text-xl font-semibold md:px-8 mx-auto block mt-4 text-white lg:text-sm rounded ">Save</button>
                </form>
            </div>

            <!-- cart summary -->
            <div class="cart_summary md:w-1/3 md:mt-16">
                <h4 class="text-center mb-4">Order Summury</h4>
                <div class="summary px-12 md:px-4 py-4 md:py-4 my-5 md:my-0 md:ml-2 bg-c_gray rounded-md ">
                    <div class="div flex justify-between px-1 py-1">
                        <span>Total Product: </span> <small>{{product_count}}</small>
                    </div>

                    <hr class="h-[.1rem] my-1 bg-cyan-100">
                    <div class="div flex justify-between px-1 py-1">
                        <span class="font-bold">Total Price: </span> <small id="totalamount" >{{total_price}} à§³</small>
                    </div>

                    {% if user_add_check %}
                    <div class="div border mt-4">
                      <form action="{% url "payment:sslcommerz_payment_gateway" %}" method="POST">
                        {% csrf_token %}
                        <button class="bg-c_primary uppercase py-1 mb-3 block text-center text-white ">Pay with SSlCommerze</>
                      </form>
                    </div>
                    {% else %}
                    <p class="text-red-700 mt-3 text-center ">Please Fill the form to continue</p>
                    {% endif %}

                </div>
            </div>

        </div>
    </section>

    <!-- payment section ends -->

{% endblock main %}

<!-- {% block script %}

<script
data-sdk-integration-source="integrationbuilder_sc"
src="https://www.paypal.com/sdk/js?client-id=AV1G6TfqN2PmWd4GKY0pn3ANtskKvGpOfTdrnmrcLXIMyxj3n_B7UJ_4oMGAot4jiNHuNEY9be_B-GIS&components=buttons&enable-funding=venmo,paylater">
</script>

<script>
    const FUNDING_SOURCES = [
      // EDIT FUNDING SOURCES
        paypal.FUNDING.PAYPAL,
        paypal.FUNDING.PAYLATER,
        paypal.FUNDING.VENMO,
        paypal.FUNDING.CARD
    ];
    FUNDING_SOURCES.forEach(fundingSource => {
      paypal.Buttons({
        fundingSource,

        style: {
          layout: 'vertical',
          shape: 'rect',
          color: (fundingSource == paypal.FUNDING.PAYLATER) ? 'gold' : '',
        },

        createOrder: async (data, actions) => {
          try {
            const response = await fetch("http://localhost:9597/orders", {
              method: "POST"
            });

            const details = await response.json();
            return details.id;
          } catch (error) {
            console.error(error);
            // Handle the error or display an appropriate error message to the user
          }
        },

        

        onApprove: async (data, actions) => {
          try {
            const response = await fetch(`http://localhost:9597/orders/${data.orderID}/capture`, {
              method: "POST"
            });

            const details = await response.json();
            // Three cases to handle:
            //   (1) Recoverable INSTRUMENT_DECLINED -> call actions.restart()
            //   (2) Other non-recoverable errors -> Show a failure message
            //   (3) Successful transaction -> Show confirmation or thank you message

            // This example reads a v2/checkout/orders capture response, propagated from the server
            // You could use a different API or structure for your 'orderData'
            const errorDetail = Array.isArray(details.details) && details.details[0];

            if (errorDetail && errorDetail.issue === 'INSTRUMENT_DECLINED') {
              return actions.restart();
              // https://developer.paypal.com/docs/checkout/integration-features/funding-failure/
            }

            if (errorDetail) {
              let msg = 'Sorry, your transaction could not be processed.';
              msg += errorDetail.description ? ' ' + errorDetail.description : '';
              msg += details.debug_id ? ' (' + details.debug_id + ')' : '';
              alert(msg);
            }

            // Successful capture! For demo purposes:
            console.log('Capture result', details, JSON.stringify(details, null, 2));
            const transaction = details.purchase_units[0].payments.captures[0];
            alert('Transaction ' + transaction.status + ': ' + transaction.id + 'See console for all available details');
          } catch (error) {
            console.error(error);
            // Handle the error or display an appropriate error message to the user
          }
        },
      }).render("#paypal-button-container");
    })
  </script>


{% endblock script %} -->
